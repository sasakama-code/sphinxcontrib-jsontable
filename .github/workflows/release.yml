name: Release to PyPI

on:
  release:
    types: [published]
  push:
    tags:
      - "v*"

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ===============================
  # Build Distribution Packages
  # ===============================
  build:
    name: Build distribution ğŸ“¦
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Debug environment and project structure
      run: |
        echo "ğŸ” Environment Debug Information"
        echo "Current working directory: $(pwd)"
        echo "Python version: $(python --version)"
        echo "Python executable: $(which python)"
        echo ""
        echo "ğŸ“ Project structure:"
        find . -type f -name "*.py" | head -20
        echo ""
        echo "ğŸ“‹ pyproject.toml exists: $(test -f pyproject.toml && echo 'Yes' || echo 'No')"
        echo "ğŸ“‹ setup.py exists: $(test -f setup.py && echo 'Yes' || echo 'No')"
        echo ""
        echo "ğŸ—‚ï¸ sphinxcontrib directory structure:"
        if [ -d "sphinxcontrib" ]; then
          find sphinxcontrib -type f -name "*.py" | sort
        else
          echo "âŒ sphinxcontrib directory not found"
        fi

    - name: Install build dependencies
      run: |
        echo "ğŸ“¦ Installing build dependencies..."
        python -m pip install --upgrade pip
        python -m pip install build twine
        echo "âœ… Build dependencies installed"

    - name: Install package dependencies
      run: |
        echo "ğŸ“¦ Installing Sphinx and package dependencies..."
        python -m pip install sphinx>=3.0 docutils>=0.18
        echo "âœ… Package dependencies installed"
        echo "ğŸ” Checking installed packages:"
        pip list | grep -E "(sphinx|docutils)" || echo "No sphinx/docutils found"

    - name: Verify project structure before installation
      run: |
        echo "ğŸ” Pre-installation verification:"
        echo "Current directory: $(pwd)"
        echo "pyproject.toml content (first 50 lines):"
        head -50 pyproject.toml
        echo ""
        echo "ğŸ“‚ Directory listing:"
        ls -la
        echo ""
        echo "ğŸ Python path:"
        python -c "import sys; [print(p) for p in sys.path]"

    - name: Install package in editable mode with verbose output
      run: |
        echo "ğŸ”§ Installing package in editable mode..."
        echo "Command: pip install -e ."
        python -m pip install -e . -v
        echo "âœ… Package installation completed"

    - name: Verify package installation
      run: |
        echo "ğŸ” Post-installation verification:"
        echo "ğŸ“¦ Installed packages:"
        pip list | grep sphinxcontrib || echo "No sphinxcontrib packages found"
        echo ""
        echo "ğŸ Python package discovery:"
        python -c "import sys, pkgutil; print('Python path:'); [print(f'  {path}') for path in sys.path]; print(); print('Checking for sphinxcontrib namespace:'); exec('try:\n    import sphinxcontrib\n    print(f\"âœ… sphinxcontrib found at: {sphinxcontrib.__path__}\")\n    for finder, name, ispkg in pkgutil.iter_modules(sphinxcontrib.__path__, \"sphinxcontrib.\"):\n        print(f\"  ğŸ“¦ {name} (package: {ispkg})\")\nexcept ImportError as e:\n    print(f\"âŒ sphinxcontrib import failed: {e}\")')"

    - name: Test package import
      run: |
        echo "ğŸ§ª Testing package import..."
        python -c "exec('try:\n    import sphinxcontrib.jsontable\n    print(\"âœ… Package imported successfully\")\n    print(f\"ğŸ“¦ Version: {sphinxcontrib.jsontable.__version__}\")\n    print(f\"ğŸ“‚ Package location: {sphinxcontrib.jsontable.__file__}\")\nexcept ImportError as e:\n    print(f\"âŒ Package import failed: {e}\")\n    import sys\n    print(f\"Python version: {sys.version}\")\n    print(f\"Python executable: {sys.executable}\")\n    print(\"Available modules in sphinxcontrib:\")\n    try:\n        import sphinxcontrib, pkgutil\n        for finder, name, ispkg in pkgutil.iter_modules(sphinxcontrib.__path__):\n            print(f\"  - {name}\")\n    except Exception as debug_e:\n        print(f\"Could not list sphinxcontrib modules: {debug_e}\")\n    raise')"

    - name: Verify Sphinx integration
      run: |
        echo "ğŸ”§ Testing Sphinx integration..."
        python -c "exec('try:\n    from sphinxcontrib.jsontable.directives import JsonTableDirective\n    print(\"âœ… Directive import successful\")\n    from sphinxcontrib.jsontable import setup\n    print(\"âœ… Setup function available\")\n    print(\"ğŸ‰ Sphinx integration verified\")\nexcept ImportError as e:\n    print(f\"âŒ Sphinx integration failed: {e}\")\n    raise')"

    - name: Run basic functionality test
      run: |
        echo "ğŸ§ª Running functionality test..."
        python -c "exec('import tempfile, os\ntest_data = \"{\\\"name\\\": \\\"test\\\", \\\"value\\\": 123}\"\nwith tempfile.NamedTemporaryFile(mode=\"w\", suffix=\".json\", delete=False) as f:\n    f.write(test_data)\n    test_file = f.name\ntry:\n    from sphinxcontrib.jsontable.directives import JsonDataLoader, TableConverter, TableBuilder\n    loader = JsonDataLoader()\n    data = loader.parse_inline([test_data])\n    print(\"âœ… JSON loading successful\")\n    converter = TableConverter()\n    table_data = converter.convert(data, include_header=True)\n    print(\"âœ… Table conversion successful\")\n    builder = TableBuilder()\n    table_node = builder.build(table_data, has_header=True)\n    print(\"âœ… Table building successful\")\n    print(\"ğŸ‰ All functionality tests passed!\")\nfinally:\n    os.unlink(test_file)')"

    - name: Build source distribution and wheel
      run: |
        echo "ğŸ”¨ Building package distributions..."
        python -m build --verbose
        echo "âœ… Build completed successfully"

    - name: Verify distributions
      run: |
        echo "ğŸ” Verifying built distributions..."
        python -m twine check dist/*
        echo "ğŸ“‹ Distribution files:"
        ls -la dist/
        echo "ğŸ“Š Distribution details:"
        for file in dist/*; do
          echo "  ğŸ“¦ $file: $(wc -c < "$file") bytes"
        done

    - name: Test wheel installation in clean environment
      run: |
        echo "ğŸ§ª Testing wheel installation in clean environment..."
        python -m venv test_env
        echo "ğŸ“¦ Installing dependencies in test environment..."
        python -m pip install sphinx>=3.0 docutils>=0.18
        echo "ğŸ“¦ Installing our wheel..."
        python -m pip install dist/*.whl
        echo "ğŸ§ª Testing import in clean environment..."
        python -c "import sphinxcontrib.jsontable; print(f'âœ… Wheel installation test passed: v{sphinxcontrib.jsontable.__version__}'); print(f'ğŸ“‚ Package location: {sphinxcontrib.jsontable.__file__}')"
        echo "ğŸ§¹ Cleaning up test environment..."
        rm -rf test_env

    - name: Store distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
        retention-days: 30

  # ===============================
  # Publish to TestPyPI (Optional)
  # ===============================
  publish-to-testpypi:
    name: Publish to TestPyPI ğŸ§ª
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    needs: [build]
    runs-on: ubuntu-latest
    environment:
      name: testpypi
      url: https://test.pypi.org/p/sphinxcontrib-jsontable
    permissions:
      id-token: write # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download distribution packages
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Verify distributions before upload
      run: |
        echo "ğŸ“‹ Files to be uploaded to TestPyPI:"
        ls -la dist/
        echo "ğŸ“Š Total files: $(ls -1 dist/ | wc -l)"

    - name: Publish to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        verbose: true
        print-hash: true

    - name: Post-upload verification
      run: |
        echo "âœ… Successfully uploaded to TestPyPI"
        echo "ğŸ”— TestPyPI URL: https://test.pypi.org/project/sphinxcontrib-jsontable/"
        echo "ğŸ“¥ Test installation: pip install -i https://test.pypi.org/simple/ sphinxcontrib-jsontable"

  # ===============================
  # Publish to PyPI (Production)
  # ===============================
  publish-to-pypi:
    name: Publish to PyPI ğŸš€
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: [build]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/sphinxcontrib-jsontable
    permissions:
      id-token: write # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download distribution packages
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    - name: Verify distributions before upload
      run: |
        echo "ğŸ“‹ Files to be uploaded to PyPI:"
        ls -la dist/
        echo "ğŸ“Š Total files: $(ls -1 dist/ | wc -l)"
        pip install twine
        python -m twine check dist/*

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        verbose: true
        print-hash: true

    - name: Post-upload verification and summary
      run: |
        echo "ğŸ‰ Successfully published to PyPI!"
        echo ""
        echo "ğŸ“¦ Package Information:"
        echo "  Name: sphinxcontrib-jsontable"
        echo "  Version: ${{ github.ref_name }}"
        echo "  PyPI URL: https://pypi.org/project/sphinxcontrib-jsontable/"
        echo ""
        echo "ğŸ“¥ Installation command:"
        echo "  pip install sphinxcontrib-jsontable"
        echo ""
        echo "ğŸ“š Documentation:"
        echo "  https://github.com/sasakama-code/sphinxcontrib-jsontable"

  # ===============================
  # Post-Release Tasks
  # ===============================
  notify-success:
    name: Notify successful release ğŸ“¢
    if: github.event_name == 'release'
    needs: [publish-to-pypi]
    runs-on: ubuntu-latest
    
    steps:
    - name: Create comprehensive success notification
      run: |
        echo "ğŸŠ RELEASE SUCCESSFUL! ğŸŠ"
        echo ""
        echo "ğŸ“¦ Package: sphinxcontrib-jsontable"
        echo "ğŸ·ï¸  Version: ${{ github.ref_name }}"
        echo "ğŸ”— PyPI: https://pypi.org/project/sphinxcontrib-jsontable/"
        echo "ğŸ“š GitHub: https://github.com/sasakama-code/sphinxcontrib-jsontable"
        echo ""
        echo "ğŸš€ Ready for installation:"
        echo "   pip install sphinxcontrib-jsontable"
        echo ""
        echo "âœ¨ Thank you for using sphinxcontrib-jsontable!"

  # ===============================
  # Handle failures
  # ===============================
  notify-failure:
    name: Handle release failure ğŸš¨
    if: failure()
    needs: [build, publish-to-pypi]
    runs-on: ubuntu-latest
    
    steps:
    - name: Report failure details
      run: |
        echo "âŒ RELEASE FAILED"
        echo ""
        echo "ğŸ” Please check the following:"
        echo "  1. Build logs for compilation errors"
        echo "  2. PyPI Trusted Publishing configuration"
        echo "  3. Package dependencies and metadata"
        echo "  4. GitHub environment permissions"
        echo ""
        echo "ğŸ“ For support, please check:"
        echo "  - GitHub Actions logs"
        echo "  - PyPI publishing status"
        echo "  - Repository issues"