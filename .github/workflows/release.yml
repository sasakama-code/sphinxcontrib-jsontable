name: Release to PyPI

on:
  release:
    types: [published]
  push:
    tags:
      - "v*"

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ===============================
  # Build Distribution Packages
  # ===============================
  build:
    name: Build distribution ğŸ“¦
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    # ===============================
    # Clean build artifacts (FIX for license-file error)
    # ===============================
    - name: Clean build artifacts
      run: |
        echo "ğŸ§¹ Cleaning previous build artifacts..."
        rm -rf dist/ build/ *.egg-info
        find . -type d -name "__pycache__" -exec rm -rf {} +
        find . -type d -name "*.egg-info" -exec rm -rf {} +
        find . -type f -name "*.pyc" -delete
        find . -type f -name "*.pyo" -delete
        echo "âœ… Cleanup completed"
        
        # Verify clean state
        echo "ğŸ“‚ Verifying clean state:"
        ls -la
        [ ! -d "dist" ] && echo "âœ“ dist/ directory removed"
        [ ! -d "build" ] && echo "âœ“ build/ directory removed"
        find . -name "*.egg-info" -type d | wc -l | grep -q "^0$" && echo "âœ“ All .egg-info directories removed"

    - name: Debug environment and project structure
      run: |
        echo "ğŸ” Environment Debug Information"
        echo "Current working directory: $(pwd)"
        echo "Python version: $(python --version)"
        echo "Python executable: $(which python)"
        echo ""
        echo "ğŸ“ Project structure:"
        find . -type f -name "*.py" | head -20
        echo ""
        echo "ğŸ“‹ pyproject.toml exists: $(test -f pyproject.toml && echo 'Yes' || echo 'No')"
        echo "ğŸ“‹ setup.py exists: $(test -f setup.py && echo 'Yes' || echo 'No')"
        echo ""
        echo "ğŸ—‚ï¸ sphinxcontrib directory structure:"
        if [ -d "sphinxcontrib" ]; then
          find sphinxcontrib -type f -name "*.py" | sort
        else
          echo "âŒ sphinxcontrib directory not found"
        fi

    # ===============================
    # Install build dependencies (FIX: twine removed)
    # ===============================
    - name: Install build dependencies
      run: |
        echo "ğŸ“¦ Installing build dependencies..."
        python -m pip install --upgrade pip
        # Install specific versions to ensure compatibility (twine removed)
        python -m pip install "setuptools>=77.0.0" "wheel>=0.44.0" "build>=1.2.2"
        echo "âœ… Build dependencies installed"
        echo ""
        echo "ğŸ” Verifying tool versions:"
        python -c "import setuptools; print(f'setuptools: {setuptools.__version__}')"
        python -c "import wheel; print(f'wheel: {wheel.__version__}')"
        pip show build | grep Version

    - name: Install package dependencies
      run: |
        echo "ğŸ“¦ Installing Sphinx and package dependencies..."
        python -m pip install sphinx>=3.0 docutils>=0.18
        echo "âœ… Package dependencies installed"
        echo "ğŸ” Checking installed packages:"
        pip list | grep -E "(sphinx|docutils)" || echo "No sphinx/docutils found"

    - name: Verify project structure before installation
      run: |
        echo "ğŸ” Pre-installation verification:"
        echo "Current directory: $(pwd)"
        echo "pyproject.toml content (first 50 lines):"
        head -50 pyproject.toml
        echo ""
        echo "ğŸ“‚ Directory listing:"
        ls -la
        echo ""
        echo "ğŸ Python path:"
        python -c "import sys; [print(p) for p in sys.path]"

    - name: Install package in editable mode with verbose output
      run: |
        echo "ğŸ”§ Installing package in editable mode..."
        echo "Command: pip install -e ."
        python -m pip install -e . -v
        echo "âœ… Package installation completed"

    - name: Verify package installation
      run: |
        echo "ğŸ” Post-installation verification:"
        echo "ğŸ“¦ Installed packages:"
        pip list | grep sphinxcontrib || echo "No sphinxcontrib packages found"
        echo ""
        echo "ğŸ Python package discovery:"
        python << 'EOF'
        import sys, pkgutil
        print('Python path:')
        for path in sys.path:
            print(f'  {path}')
        print()
        print('Checking for sphinxcontrib namespace:')
        try:
            import sphinxcontrib
            print(f"âœ… sphinxcontrib found at: {sphinxcontrib.__path__}")
            for finder, name, ispkg in pkgutil.iter_modules(sphinxcontrib.__path__, "sphinxcontrib."):
                print(f"  ğŸ“¦ {name} (package: {ispkg})")
        except ImportError as e:
            print(f"âŒ sphinxcontrib import failed: {e}")
        EOF

    - name: Test package import
      run: |
        echo "ğŸ§ª Testing package import..."
        python << 'EOF'
        try:
            import sphinxcontrib.jsontable
            print("âœ… Package imported successfully")
            print(f"ğŸ“¦ Version: {sphinxcontrib.jsontable.__version__}")
            print(f"ğŸ“‚ Package location: {sphinxcontrib.jsontable.__file__}")
        except ImportError as e:
            print(f"âŒ Package import failed: {e}")
            import sys
            print(f"Python version: {sys.version}")
            print(f"Python executable: {sys.executable}")
            print("Available modules in sphinxcontrib:")
            try:
                import sphinxcontrib, pkgutil
                for finder, name, ispkg in pkgutil.iter_modules(sphinxcontrib.__path__):
                    print(f"  - {name}")
            except Exception as debug_e:
                print(f"Could not list sphinxcontrib modules: {debug_e}")
            raise
        EOF

    - name: Verify Sphinx integration
      run: |
        echo "ğŸ”§ Testing Sphinx integration..."
        python << 'EOF'
        try:
            from sphinxcontrib.jsontable.directives import JsonTableDirective
            print("âœ… Directive import successful")
            from sphinxcontrib.jsontable import setup
            print("âœ… Setup function available")
            print("ğŸ‰ Sphinx integration verified")
        except ImportError as e:
            print(f"âŒ Sphinx integration failed: {e}")
            raise
        EOF

    - name: Run basic functionality test
      run: |
        echo "ğŸ§ª Running functionality test..."
        python << 'EOF'
        import tempfile, os, json

        test_data_dict = {"name": "test", "value": 123}
        test_data = json.dumps(test_data_dict)

        with tempfile.NamedTemporaryFile(mode="w", suffix=".json", delete=False) as f:
            f.write(test_data)
            test_file = f.name

        try:
            from sphinxcontrib.jsontable.directives import JsonDataLoader, TableConverter, TableBuilder
            
            loader = JsonDataLoader()
            data = loader.parse_inline([test_data])
            print("âœ… JSON loading successful")
            
            converter = TableConverter()
            table_data = converter.convert(data, include_header=True)
            print("âœ… Table conversion successful")
            
            builder = TableBuilder()
            table_node = builder.build(table_data, has_header=True)
            print("âœ… Table building successful")
            
            print("ğŸ‰ All functionality tests passed!")
            
        finally:
            os.unlink(test_file)
        EOF

    # ===============================
    # Extra cleanup before build (FIX for license-file error)
    # ===============================
    - name: Final cleanup before build
      run: |
        echo "ğŸ§¹ Final cleanup before build..."
        rm -rf dist/ build/ *.egg-info
        find . -type d -name "*.egg-info" -exec rm -rf {} +
        echo "âœ… Final cleanup completed"

    - name: Build source distribution and wheel
      run: |
        echo "ğŸ”¨ Building package distributions..."
        python -m build --verbose
        echo "âœ… Build completed successfully"

    # ===============================
    # Basic verification without twine
    # ===============================
    - name: Verify distributions
      run: |
        echo "ğŸ” Verifying built distributions..."
        echo "ğŸ“‹ Distribution files:"
        ls -la dist/
        echo "ğŸ“Š Distribution details:"
        for file in dist/*; do
          echo "  ğŸ“¦ $file: $(wc -c < "$file") bytes"
        done
        echo ""
        echo "ğŸ” Checking wheel metadata structure:"
        python << 'EOF'
        import zipfile
        import glob
        
        wheel_files = glob.glob("dist/*.whl")
        if wheel_files:
            wheel_file = wheel_files[0]
            print(f"Checking {wheel_file}")
            with zipfile.ZipFile(wheel_file, 'r') as zf:
                # List all files in wheel
                print("Files in wheel:")
                for f in sorted(zf.namelist())[:10]:  # Show first 10 files
                    print(f"  - {f}")
                
                # Check for METADATA file
                metadata_files = [f for f in zf.namelist() if f.endswith('METADATA')]
                if metadata_files:
                    print(f"\nâœ… Found METADATA file: {metadata_files[0]}")
                    metadata_content = zf.read(metadata_files[0]).decode('utf-8')
                    
                    # Check metadata version
                    for line in metadata_content.split('\n')[:5]:  # Show first 5 lines
                        print(f"  {line}")
                else:
                    print("âŒ No METADATA file found in wheel")
        
        # Check source distribution
        tar_files = glob.glob("dist/*.tar.gz")
        if tar_files:
            print(f"\nâœ… Found source distribution: {tar_files[0]}")
        EOF

    - name: Test wheel installation in clean environment
      run: |
        echo "ğŸ§ª Testing wheel installation in clean environment..."
        python -m venv test_env
        echo "ğŸ“¦ Installing dependencies in test environment..."
        test_env/bin/python -m pip install sphinx>=3.0 docutils>=0.18
        echo "ğŸ“¦ Installing our wheel..."
        test_env/bin/python -m pip install dist/*.whl
        echo "ğŸ§ª Testing import in clean environment..."
        test_env/bin/python -c "import sphinxcontrib.jsontable; print(f'âœ… Wheel installation test passed: v{sphinxcontrib.jsontable.__version__}'); print(f'ğŸ“‚ Package location: {sphinxcontrib.jsontable.__file__}')"
        echo "ğŸ§¹ Cleaning up test environment..."
        rm -rf test_env

    - name: Store distribution packages
      uses: actions/upload-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
        retention-days: 30

  # ===============================
  # Publish to PyPI (Production)
  # ===============================
  publish-to-pypi:
    name: Publish to PyPI ğŸš€
    if: github.event_name == 'release' && github.event.action == 'published'
    needs: [build]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/sphinxcontrib-jsontable
    permissions:
      id-token: write # IMPORTANT: mandatory for trusted publishing

    steps:
    - name: Download distribution packages
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    # ===============================
    # Basic verification before PyPI upload
    # ===============================
    - name: Verify distributions before upload
      run: |
        echo "ğŸ“‹ Files to be uploaded to PyPI:"
        ls -la dist/
        echo "ğŸ“Š Total files: $(ls -1 dist/ | wc -l)"
        echo ""
        echo "ğŸ” Checking distribution files exist:"
        [ -f dist/*.whl ] && echo "âœ… Wheel file found" || echo "âŒ No wheel file found"
        [ -f dist/*.tar.gz ] && echo "âœ… Source distribution found" || echo "âŒ No source distribution found"
        echo ""
        echo "âœ… Ready for PyPI upload"

    # pypa/gh-action-pypi-publish will automatically run twine check internally
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        verbose: true
        print-hash: true

    - name: Post-upload verification and summary
      run: |
        echo "ğŸ‰ Successfully published to PyPI!"
        echo ""
        echo "ğŸ“¦ Package Information:"
        echo "  Name: sphinxcontrib-jsontable"
        echo "  Version: ${{ github.ref_name }}"
        echo "  PyPI URL: https://pypi.org/project/sphinxcontrib-jsontable/"
        echo ""
        echo "ğŸ“¥ Installation command:"
        echo "  pip install sphinxcontrib-jsontable"
        echo ""
        echo "ğŸ“š Documentation:"
        echo "  https://github.com/sasakama-code/sphinxcontrib-jsontable"

  # ===============================
  # Post-Release Tasks
  # ===============================
  notify-success:
    name: Notify successful release ğŸ“¢
    if: github.event_name == 'release'
    needs: [publish-to-pypi]
    runs-on: ubuntu-latest
    
    steps:
    - name: Create comprehensive success notification
      run: |
        echo "ğŸŠ RELEASE SUCCESSFUL! ğŸŠ"
        echo ""
        echo "ğŸ“¦ Package: sphinxcontrib-jsontable"
        echo "ğŸ·ï¸  Version: ${{ github.ref_name }}"
        echo "ğŸ”— PyPI: https://pypi.org/project/sphinxcontrib-jsontable/"
        echo "ğŸ“š GitHub: https://github.com/sasakama-code/sphinxcontrib-jsontable"
        echo ""
        echo "ğŸš€ Ready for installation:"
        echo "   pip install sphinxcontrib-jsontable"
        echo ""
        echo "âœ¨ Thank you for using sphinxcontrib-jsontable!"

  # ===============================
  # Handle failures
  # ===============================
  notify-failure:
    name: Handle release failure ğŸš¨
    if: failure()
    needs: [build, publish-to-pypi]
    runs-on: ubuntu-latest
    
    steps:
    - name: Report failure details
      run: |
        echo "âŒ RELEASE FAILED"
        echo ""
        echo "ğŸ” Please check the following:"
        echo "  1. Build logs for compilation errors"
        echo "  2. PyPI Trusted Publishing configuration"
        echo "  3. Package dependencies and metadata"
        echo "  4. GitHub environment permissions"
        echo ""
        echo "ğŸ“ For support, please check:"
        echo "  - GitHub Actions logs"
        echo "  - PyPI publishing status"
        echo "  - Repository issues"
